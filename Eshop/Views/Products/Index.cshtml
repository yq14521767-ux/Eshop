@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@

@model X.PagedList.IPagedList<Eshop.Models.Product>
@using X.PagedList.Mvc.Core

@{
	ViewData["Title"] = "商品列表";
}

@if (TempData["Success"] != null)
{
	<script>
		alert('@Html.Raw(TempData["Success"])');
		 @{
				 TempData.Remove("Success");
		 }
	</script>
}

<div class="page-header">
	<h2 class="m-0">商品列表</h2>
	<form method="get" asp-action="Index" class="d-flex align-items-center">
		<input type="text"
			   name="search"
			   class="form-control form-control-sm border border-gray-300 rounded"
			   placeholder="搜索商品..."
			   value="@ViewBag.Search"
			   style="width: 220px;" />
		<button type="submit" class="btn btn-sm btn-light border border-gray-300 ms-2 px-3">搜索</button>
	</form>
</div>

<div class="row g-3">
	@foreach (var item in Model)
	{
		<div class="col-12 col-sm-6 col-md-4 col-lg-3">
			<div class="card h-100">
				@if (!string.IsNullOrEmpty(item.ImageUrl))
				{
					<img class="card-img-top" src="@item.ImageUrl" alt="@item.Name" />
				}
				<div class="card-body d-flex flex-column">
					<h5 class="card-title">@item.Name</h5>
					<p class="card-text text-danger fw-semibold mb-3">¥@item.Price.ToString("F2")</p>
					<div class="mt-auto d-grid gap-2">
						<a asp-action="Details" 
						    asp-route-id="@item.Id" 
						    class="btn btn-outline-primary btn-sm"
						    asp-route-page="@Model.PageNumber"
						    asp-route-search="@ViewBag.Search">查看详情
					    </a>

						<form asp-controller="Cart" asp-action="AddToCart" method="post">
							@Html.AntiForgeryToken()
							<input type="hidden" name="productId" value="@item.Id" />
							<div class="input-group input-group-sm">
								<input type="number" class="form-control" name="quantity" value="1" min="1" max="@item.Stock" />
								<input type="hidden" name="page" value="@(Model?.PageNumber ?? 1)" />
								<input type="hidden" name="search" value="@ViewBag.Search" />
								<button type="submit" class="btn btn-primary">加入购物车</button>
							</div>
						</form>

					</div>
				</div>
			</div>
		</div>
	}
</div>

<div class="mt-3 d-flex justify-content-center">
	@Html.PagedListPager(
	    Model,
	    page => Url.Action("Index",new { page, search = ViewBag.Search }),
		new PagedListRenderOptions
		{
			//始终显示首页与尾页
			DisplayLinkToFirstPage = PagedListDisplayMode.Always,
            DisplayLinkToLastPage = PagedListDisplayMode.Always,
			//始终显示上一页和下一页
            DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
            DisplayLinkToNextPage = PagedListDisplayMode.Always,
			//最多显示5个页码
            MaximumPageNumbersToDisplay = 5,

            UlElementClasses = new[] { "pagination" },
            LiElementClasses = new[] { "page-item" },
            PageClasses = new[] { "page-link" }
		}
	)
</div>

@if (ViewBag.Success != null)
{
	<div class="alert alert-info mt-3">@ViewBag.Success</div>
}